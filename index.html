<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalWork Pro | V11 Cloud Sync</title>
    <style>
        :root { --primary: #00d2ff; --bg: #000; --card: #121212; --success: #2ecc71; --danger: #ff4b2b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 0; overflow: hidden; }
        #splash { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #splash h1 { color: var(--primary); font-size: 2.2rem; }
        .main-content { display: none; flex-direction: column; height: 100vh; }
        .header { padding: 15px 25px; display: flex; justify-content: flex-end; }
        .settings-btn { background: none; border: none; font-size: 26px; cursor: pointer; color: #888; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-box { background: var(--card); border: 1px solid #333; border-radius: 25px; padding: 20px; width: 85%; max-height: 85%; overflow-y: auto; text-align: center; }
        .pin-display { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--primary); }
        .pin-dot.active { background: var(--primary); }
        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn { background: #1a1a1a; border: none; color: #fff; padding: 15px; border-radius: 12px; font-size: 1.2rem; }
        .menu { position: fixed; top: -100%; left: 0; width: 100%; background: var(--card); transition: 0.5s; padding: 25px; z-index: 1000; border-bottom: 2px solid var(--primary); border-radius: 0 0 25px 25px; box-sizing: border-box; }
        .menu.active { top: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; font-size: 14px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .day-btn { background: #1a1a1a; border: 1px solid #333; padding: 12px 0; border-radius: 8px; font-size: 11px; color: #fff; }
        .day-btn.has-data { border-color: var(--success); color: var(--success); }
        #work-timer { font-size: 3.5rem; text-align: center; color: var(--primary); font-family: monospace; margin: 20px 0; }
        .controls { display: flex; justify-content: center; gap: 30px; margin-top: auto; padding-bottom: 40px; }
        .circle-btn { width: 85px; height: 85px; border-radius: 50%; border: none; color: #fff; font-weight: bold; }
        input { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 10px; width: 100%; margin: 5px 0; text-align: center; }
    </style>
</head>
<body onload="initApp()">

    <div id="splash">
        <h1>CalWork Pro</h1>
        <div style="color:#555; font-size:0.8rem">V11 - Live Sync</div>
    </div>

    <div class="main-content" id="app">
        <div class="header"><button class="settings-btn" onclick="toggleMenu()">âš™ï¸</button></div>
        <div id="settingsMenu" class="menu">
            <div class="menu-item" style="padding:15px" onclick="openCalendar()">ğŸ“… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…</div>
            <div class="menu-item" style="padding:15px" onclick="openPassModal()">ğŸ”’ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</div>
            <input type="email" id="targetEmail" placeholder="Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" onchange="saveEmail(this.value)">
            <div class="menu-item" style="padding:15px; color:var(--primary)" onclick="sendEmailReport()">ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø¥ÙŠÙ…ÙŠÙ„</div>
            <div class="menu-item" style="padding:15px; color:var(--danger)" onclick="toggleMenu()">âœ• Ø¥ØºÙ„Ø§Ù‚</div>
        </div>
        <div id="work-timer">00:00:00</div>
        <div class="controls">
            <button id="inBtn" class="circle-btn" style="background:var(--success)" onclick="askPIN('in')">CHECK IN</button>
            <button id="outBtn" class="circle-btn" style="background:var(--danger); opacity:0.3" onclick="askPIN('out')">CHECK OUT</button>
        </div>
    </div>

    <div id="pinOverlay" class="overlay"><div class="modal-box"><h3>Enter PIN</h3><div class="pin-display"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div><div class="num-pad"><button class="num-btn" onclick="pressNum(1)">1</button><button class="num-btn" onclick="pressNum(2)">2</button><button class="num-btn" onclick="pressNum(3)">3</button><button class="num-btn" onclick="pressNum(4)">4</button><button class="num-btn" onclick="pressNum(5)">5</button><button class="num-btn" onclick="pressNum(6)">6</button><button class="num-btn" onclick="pressNum(7)">7</button><button class="num-btn" onclick="pressNum(8)">8</button><button class="num-btn" onclick="pressNum(9)">9</button><button class="num-btn" onclick="closeModals()">âœ•</button><button class="num-btn" onclick="pressNum(0)">0</button><button class="num-btn" onclick="clearPIN()">âŒ«</button></div></div></div>
    <div id="logOverlay" class="overlay"><div class="modal-box" style="width:95%"><div class="calendar-grid" id="calendarGrid"></div><div id="dayDetail" style="margin-top:15px; text-align:right"></div><button onclick="closeModals()" style="width:100%; padding:12px; background:var(--danger); border:none; color:#fff; border-radius:12px; margin-top:15px">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

    <script>
        const SCRIPT_URL = 'Ø­Ø·_Ø§Ù„Ø±Ø§Ø¨Ø·_Ø§Ù„Ù„ÙŠ_Ù†Ø³Ø®ØªÙ‡_Ù‡Ù†Ø§'; // <--- Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…ØªÙŠÙ† ''

        let logs = JSON.parse(localStorage.getItem('calwork_db')) || {};
        let appPass = localStorage.getItem('appPass') || "1234";
        let currentPIN = "", targetAction = "", timer, seconds = 0;

        function initApp() {
            if (navigator.onLine) {
                fetch(window.location.href + '?t=' + new Date().getTime(), { method: 'HEAD', cache: 'no-cache' })
                .then(res => {
                    const latest = res.headers.get('last-modified');
                    if (localStorage.getItem('last_upd') && localStorage.getItem('last_upd') !== latest) {
                        localStorage.setItem('last_upd', latest);
                        location.reload(true);
                    }
                    localStorage.setItem('last_upd', latest);
                });
            }
            setTimeout(() => { document.getElementById('splash').style.display='none'; document.getElementById('app').style.display='flex'; }, 3000);
            document.getElementById('targetEmail').value = localStorage.getItem('targetEmail') || "";
        }

        function toggleMenu() { document.getElementById('settingsMenu').classList.toggle('active'); }
        function closeModals() { document.querySelectorAll('.overlay').forEach(el => el.style.display='none'); currentPIN = ""; updatePinDots(); }
        function saveEmail(val) { localStorage.setItem('targetEmail', val); }

        function askPIN(type) { targetAction = type; document.getElementById('pinOverlay').style.display='flex'; }
        function pressNum(n) {
            if(currentPIN.length < 4) {
                currentPIN += n; updatePinDots();
                if(currentPIN.length === 4) {
                    if(currentPIN === appPass) { closeModals(); targetAction === 'in' ? startWork() : stopWork(); }
                    else { alert("Wrong PIN!"); currentPIN = ""; updatePinDots(); }
                }
            }
        }
        function updatePinDots() { const dots = document.querySelectorAll('.pin-dot'); dots.forEach((dot, i) => dot.classList.toggle('active', i < currentPIN.length)); }

        function startWork() {
            document.getElementById('inBtn').style.opacity="0.3"; document.getElementById('outBtn').style.opacity="1";
            window.entryTime = new Date();
            timer = setInterval(() => { seconds++; updateTimerDisplay(); }, 1000);
        }
        function updateTimerDisplay() {
            let h=Math.floor(seconds/3600).toString().padStart(2,'0'), m=Math.floor((seconds%3600)/60).toString().padStart(2,'0'), s=(seconds%60).toString().padStart(2,'0');
            document.getElementById('work-timer').innerText = `${h}:${m}:${s}`;
        }

        function stopWork() {
            clearInterval(timer);
            const start = window.entryTime, end = new Date();
            const key = `${start.getFullYear()}-${start.getMonth()+1}-${start.getDate()}`;
            const logEntry = {
                date: start.toLocaleDateString('en-GB'),
                in: start.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
                out: end.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
                total: (seconds/3600).toFixed(2),
                email: localStorage.getItem('targetEmail') || "guest"
            };

            logs[key] = logEntry;
            localStorage.setItem('calwork_db', JSON.stringify(logs));

            if (navigator.onLine && SCRIPT_URL !== 'Ø­Ø·_Ø§Ù„Ø±Ø§Ø¨Ø·_Ø§Ù„Ù„ÙŠ_Ù†Ø³Ø®ØªÙ‡_Ù‡Ù†Ø§') {
                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(logEntry) })
                .then(() => alert("ØªÙ… Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨ âœ…"));
            }

            seconds = 0;
            document.getElementById('work-timer').innerText = "00:00:00";
            document.getElementById('inBtn').style.opacity="1";
            document.getElementById('outBtn').style.opacity="0.3";
        }

        function openCalendar() { toggleMenu(); document.getElementById('logOverlay').style.display='flex'; renderCalendar(); }
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = "";
            const daysInMonth = 31; 
            for(let i=1; i<=daysInMonth; i++) {
                const key = `${new Date().getFullYear()}-${new Date().getMonth()+1}-${i}`;
                const btn = document.createElement('div');
                btn.className = `day-btn ${logs[key] ? 'has-data' : ''}`;
                btn.innerText = i;
                btn.onclick = () => showDay(key);
                grid.appendChild(btn);
            }
        }
        function showDay(key) {
            const d = logs[key];
            document.getElementById('dayDetail').innerHTML = d ? `
                <p>ØªØ§Ø±ÙŠØ®: ${d.date}</p><p>Ø­Ø¶ÙˆØ±: ${d.in}</p><p>Ø§Ù†ØµØ±Ø§Ù: ${d.out}</p><p>Ø³Ø§Ø¹Ø§Øª: ${d.total}</p>
            ` : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
        }
        function sendEmailReport() {
            const target = localStorage.getItem('targetEmail');
            if(!target) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„!");
            let r = "Work Report\n\n";
            for(let k in logs) r += `${logs[k].date}: In ${logs[k].in} | Out ${logs[k].out} | Total ${logs[k].total}hr\n`;
            window.location.href = `mailto:${target}?subject=CalWork Data&body=${encodeURIComponent(r)}`;
        }
    </script>
</body>
</html>
