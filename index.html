<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalWork Pro | V17 Master</title>
    <style>
        @font-face { font-family: 'Digital'; src: url('https://fonts.cdnfonts.com/s/14234/DS-DIGI.woff') format('woff'); }
        :root { --primary: #00d2ff; --bg: #000; --card: #121212; --success: #2ecc71; --danger: #ff4b2b; --glow: #39FF14; --selection: rgba(0, 210, 255, 0.3); }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; height: 100vh; }

        /* ساعة العقارب بالأرقام المضيئة */
        .clock-container { position: relative; width: 210px; height: 210px; margin-top: 20px; border-radius: 50%; border: 2px solid #222; background: radial-gradient(circle, #0a0a0a 0%, #000 100%); box-shadow: 0 0 20px rgba(0, 210, 255, 0.1); }
        .hand { position: absolute; bottom: 50%; left: 50%; transform-origin: bottom; border-radius: 10px; }
        .hour-hand { width: 6px; height: 45px; background: #fff; z-index: 10; box-shadow: 0 0 5px #fff; }
        .min-hand { width: 4px; height: 70px; background: var(--glow); z-index: 11; box-shadow: 0 0 10px var(--glow); }
        .sec-hand { width: 2px; height: 80px; background: var(--danger); z-index: 12; }
        .clock-num { position: absolute; width: 100%; height: 100%; text-align: center; font-weight: bold; font-size: 16px; color: var(--primary); text-shadow: 0 0 8px var(--primary); padding: 5px; box-sizing: border-box; }
        
        /* العداد الرقمي */
        #work-timer { font-family: 'Digital', sans-serif; font-size: 4rem; color: var(--primary); margin: 15px 0; text-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }

        /* النوافذ والتقويم */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.97); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal-box { background: var(--card); border: 1px solid #333; border-radius: 25px; padding: 20px; width: 90%; max-height: 90%; overflow-y: auto; text-align: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .day-btn { background: #1a1a1a; border: 1px solid #333; padding: 12px 0; border-radius: 10px; font-size: 12px; color: #fff; position: relative; cursor: pointer; }
        .day-btn.has-data { border-color: var(--success); }
        .day-btn.has-data::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--success); border-radius: 50%; }
        .day-btn.selected { background: var(--selection); border-color: var(--primary); }

        /* لوحة الأرقام PIN */
        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .num-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 18px; border-radius: 15px; font-size: 1.4rem; font-weight: bold; }
        .num-btn:active { background: var(--primary); color: #000; }

        /* التوست والإشعارات */
        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 1px solid var(--primary); padding: 12px 25px; border-radius: 50px; z-index: 5000; transition: 0.5s; }
        #toast.show { bottom: 30px; }
        .settings-icon { position: absolute; top: 20px; left: 20px; font-size: 26px; color: #555; z-index: 2000; }

        /* واجهة تغيير الباسورد */
        .pass-line { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #222; }
        .pass-line.active { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        .stars { color: var(--primary); font-size: 1.4rem; letter-spacing: 3px; }
    </style>
</head>
<body onload="initApp()">

    <div class="settings-icon" onclick="toggleMenu()">⚙️</div>

    <div class="clock-container" id="analogClock">
        <div id="hour" class="hand hour-hand"></div>
        <div id="min" class="hand min-hand"></div>
        <div id="sec" class="hand sec-hand"></div>
        <div style="position:absolute; top:50%; left:50%; width:8px; height:8px; background:#fff; border-radius:50%; transform:translate(-50%,-50%); z-index:13"></div>
    </div>

    <div id="work-timer">00:00:00</div>

    <div id="status-display" style="width:85%; opacity:0; transition:0.5s; background:rgba(255,255,255,0.03); border-radius:15px; padding:12px; border:1px dashed #444">
        <div style="display:flex; justify-content:space-between"><span id="in-time" style="color:var(--glow); font-weight:bold">--:--</span><span>وقت الحضور</span></div>
        <div id="out-row" style="display:none; justify-content:space-between; margin-top:8px"><span id="out-time" style="color:var(--danger); font-weight:bold">--:--</span><span>وقت الانصراف</span></div>
    </div>

    <div class="controls" style="display:flex; gap:30px; margin-top:auto; padding-bottom:40px">
        <button id="inBtn" style="width:90px; height:90px; border-radius:50%; border:none; background:var(--success); color:#fff; font-weight:bold" onclick="askPIN('in')">IN</button>
        <button id="outBtn" style="width:90px; height:90px; border-radius:50%; border:none; background:var(--danger); color:#fff; font-weight:bold; opacity:0.3" onclick="askPIN('out')">OUT</button>
    </div>

    <div id="pinOverlay" class="overlay"><div class="modal-box">
        <h3 id="pinTitle">التحقق من الهوية</h3>
        <div style="display:flex; justify-content:center; gap:10px; margin:20px 0" id="dots">
            <div class="pin-dot" style="width:15px; height:15px; border-radius:50%; border:2px solid var(--primary)"></div>
            <div class="pin-dot" style="width:15px; height:15px; border-radius:50%; border:2px solid var(--primary)"></div>
            <div class="pin-dot" style="width:15px; height:15px; border-radius:50%; border:2px solid var(--primary)"></div>
            <div class="pin-dot" style="width:15px; height:15px; border-radius:50%; border:2px solid var(--primary)"></div>
        </div>
        <div class="num-pad">
            <button class="num-btn" onclick="pressNum(1)">1</button><button class="num-btn" onclick="pressNum(2)">2</button><button class="num-btn" onclick="pressNum(3)">3</button>
            <button class="num-btn" onclick="pressNum(4)">4</button><button class="num-btn" onclick="pressNum(5)">5</button><button class="num-btn" onclick="pressNum(6)">6</button>
            <button class="num-btn" onclick="pressNum(7)">7</button><button class="num-btn" onclick="pressNum(8)">8</button><button class="num-btn" onclick="pressNum(9)">9</button>
            <button class="num-btn" onclick="closePIN()">✕</button><button class="num-btn" onclick="pressNum(0)">0</button><button class="num-btn" onclick="clearPIN()">⌫</button>
        </div>
    </div></div>

    <div id="passOverlay" class="overlay"><div class="modal-box">
        <h3 style="color:var(--primary); margin-bottom:20px">تغيير كلمة المرور</h3>
        <div class="pass-line" id="l1"><span>Old PIN</span><div id="s1" class="stars"></div></div>
        <div class="pass-line" id="l2"><span>New PIN</span><div id="s2" class="stars"></div></div>
        <div class="pass-line" id="l3"><span>Confirm</span><div id="s3" class="stars"></div></div>
        <div class="num-pad">
            <button class="num-btn" onclick="pNum(1)">1</button><button class="num-btn" onclick="pNum(2)">2</button><button class="num-btn" onclick="pNum(3)">3</button>
            <button class="num-btn" onclick="pNum(4)">4</button><button class="num-btn" onclick="pNum(5)">5</button><button class="num-btn" onclick="pNum(6)">6</button>
            <button class="num-btn" onclick="pNum(7)">7</button><button class="num-btn" onclick="pNum(8)">8</button><button class="num-btn" onclick="pNum(9)">9</button>
            <button class="num-btn" onclick="closePass()">✕</button><button class="num-btn" onclick="pNum(0)">0</button><button class="num-btn" onclick="clearPass()">⌫</button>
        </div>
    </div></div>

    <div id="logOverlay" class="overlay"><div class="modal-box">
        <h3 style="margin:0">سجل الحضور الذكي</h3>
        <div id="calHeader" style="color:var(--primary); margin:10px 0; font-weight:bold"></div>
        <div class="calendar-grid" id="grid"></div>
        <div id="dayInfo" style="margin-top:15px; color:#aaa; font-size:14px; min-height:40px">اضغط على يوم للتفاصيل</div>
        <div id="rangeRes"></div>
        <button onclick="closeModals()" style="width:100%; padding:15px; background:var(--danger); border:none; color:#fff; border-radius:15px; margin-top:15px; font-weight:bold">إغلاق</button>
    </div></div>

    <div id="toast">✅ تم بنجاح</div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvmKQlFFEr5vkGe3GLCmAADIJRcGVnXWimP3NSQgNZ35SPaDzr91BV-JeJPicO0FVw/exec';
        let timer, seconds=0, currentPIN="", targetAction="", appPass=localStorage.getItem('appPass')||"1234", logs=JSON.parse(localStorage.getItem('calwork_db'))||{};
        let pStep=1, t1="", t2="", t3="", selDays=[];

        function initApp() {
            createClockNumbers();
            setInterval(updateClock, 1000);
            document.getElementById('targetEmail').value = localStorage.getItem('targetEmail') || "";
        }

        function createClockNumbers() {
            const container = document.getElementById('analogClock');
            for(let i=1; i<=12; i++) {
                let div = document.createElement('div');
                div.className = 'clock-num';
                div.innerText = i;
                div.style.transform = `rotate(${i * 30}deg)`;
                container.appendChild(div);
            }
        }

        function updateClock() {
            const n = new Date();
            const h=n.getHours()%12, m=n.getMinutes(), s=n.getSeconds();
            document.getElementById('hour').style.transform=`translateX(-50%) rotate(${h*30+m*0.5}deg)`;
            document.getElementById('min').style.transform=`translateX(-50%) rotate(${m*6}deg)`;
            document.getElementById('sec').style.transform=`translateX(-50%) rotate(${s*6}deg)`;
        }

        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

        // نظام البصمة
        function askPIN(a) { targetAction=a; document.getElementById('pinOverlay').style.display='flex'; }
        function pressNum(n) { if(currentPIN.length<4){ currentPIN+=n; updateDots(); if(currentPIN.length==4) checkPIN(); } }
        function updateDots() { document.querySelectorAll('.pin-dot').forEach((d,i)=>d.style.background=i<currentPIN.length? 'var(--primary)':'none'); }
        function checkPIN() { if(currentPIN===appPass){ closePIN(); targetAction=='in'?startWork():stopWork(); } else { showToast("❌ PIN خطأ"); clearPIN(); } }
        function clearPIN() { currentPIN=""; updateDots(); }
        function closePIN() { document.getElementById('pinOverlay').style.display='none'; clearPIN(); }

        function startWork() {
            window.entryTime = new Date();
            document.getElementById('in-time').innerText = window.entryTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('status-display').style.opacity='1';
            document.getElementById('inBtn').style.opacity='0.3'; document.getElementById('outBtn').style.opacity='1';
            timer = setInterval(() => { seconds++; let h=Math.floor(seconds/3600).toString().padStart(2,'0'), m=Math.floor((seconds%3600)/60).toString().padStart(2,'0'), s=(seconds%60).toString().padStart(2,'0'); document.getElementById('work-timer').innerText=`${h}:${m}:${s}`; }, 1000);
        }

        function stopWork() {
            clearInterval(timer); const now = new Date();
            document.getElementById('out-time').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('out-row').style.display='flex';
            let t=(seconds/3600).toFixed(2), b=t>8?8:t, e=t>8?(t-8).toFixed(2):"0.00";
            const entry = { date: now.toLocaleDateString('en-GB'), in: window.entryTime.toLocaleTimeString('en-GB'), out: now.toLocaleTimeString('en-GB'), total: t, basic: b, extra: e };
            logs[`${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`] = entry;
            localStorage.setItem('calwork_db', JSON.stringify(logs));
            if(navigator.onLine) fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({...entry, email:localStorage.getItem('targetEmail')})});
            showToast("✅ تم رفع البيانات");
            setTimeout(() => { document.getElementById('status-display').style.opacity='0'; document.getElementById('work-timer').innerText="00:00:00"; document.getElementById('inBtn').style.opacity='1'; document.getElementById('outBtn').style.opacity='0.3'; seconds=0; }, 10000);
        }

        // التقويم المطور
        function openCalendar() { document.getElementById('logOverlay').style.display='flex'; renderCycle(); }
        function renderCycle() {
            const grid = document.getElementById('grid'); grid.innerHTML = "";
            const now = new Date();
            const months = ["يناير", "فبراير", "مارس", "إبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            document.getElementById('calHeader').innerText = `${months[now.getMonth()]} ${now.getFullYear()}`;
            let start = new Date(now.getFullYear(), now.getMonth()-1, 26);
            let end = new Date(now.getFullYear(), now.getMonth(), 26);
            for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                let dayNum = d.getDate();
                let key = `${d.getFullYear()}-${d.getMonth()+1}-${dayNum}`;
                const btn = document.createElement('div');
                btn.className = `day-btn ${logs[key] ? 'has-data' : ''} ${selDays.includes(key) ? 'selected' : ''}`;
                btn.innerText = dayNum;
                btn.onclick = () => showDayDetails(key);
                let hold; btn.onmousedown = btn.ontouchstart = () => hold = setTimeout(()=>selectRange(key), 600);
                btn.onmouseup = btn.ontouchend = () => clearTimeout(hold);
                grid.appendChild(btn);
            }
        }

        function showDayDetails(k) {
            const d = logs[k];
            document.getElementById('dayInfo').innerHTML = d ? `يوم ${d.date}<br>حضور: ${d.in} | انصراف: ${d.out}<br>إجمالي: ${d.total} ساعة` : "لا توجد بيانات لهذا اليوم";
        }

        function selectRange(k) {
            if(selDays.length>=2) selDays=[];
            selDays.push(k); selDays.sort((a,b)=>new Date(a)-new Date(b));
            renderCycle();
            if(selDays.length==2) {
                let b=0, e=0;
                for(let key in logs) {
                    let d = new Date(key), s = new Date(selDays[0]), en = new Date(selDays[1]);
                    if(d>=s && d<=en) { b+=parseFloat(logs[key].basic); e+=parseFloat(logs[key].extra); }
                }
                document.getElementById('rangeRes').innerHTML = `<div style="background:#1a1a1a; padding:15px; border-radius:15px; border-right:4px solid var(--primary); text-align:right; margin-top:10px">الأساسي: ${b.toFixed(2)} hr | <span style="color:var(--primary)">الإضافي: ${e.toFixed(2)} hr</span></div>`;
            }
        }

        // نظام تغيير الباسورد
        function openPassModal() { toggleMenu(); document.getElementById('passOverlay').style.display='flex'; pStep=1; updatePassUI(); }
        function pNum(n) {
            if(pStep==1 && t1.length<4) t1+=n;
            else if(pStep==2 && t2.length<4) t2+=n;
            else if(pStep==3 && t3.length<4) t3+=n;
            if(t1.length==4 && pStep==1) pStep=2;
            if(t2.length==4 && pStep==2) pStep=3;
            if(t3.length==4 && pStep==3) finishPass();
            updatePassUI();
        }
        function updatePassUI() {
            document.getElementById('s1').innerText = "*".repeat(t1.length);
            document.getElementById('s2').innerText = "*".repeat(t2.length);
            document.getElementById('s3').innerText = "*".repeat(t3.length);
            document.getElementById('l1').className = pStep==1?'pass-line active':'pass-line';
            document.getElementById('l2').className = pStep==2?'pass-line active':'pass-line';
            document.getElementById('l3').className = pStep==3?'pass-line active':'pass-line';
        }
        function finishPass() {
            if(t1!==appPass){ showToast("❌ القديم خطأ"); clearPass(); }
            else if(t2!==t3){ showToast("❌ لا يوجد تطابق"); t2=""; t3=""; pStep=2; }
            else { localStorage.setItem('appPass', t2); appPass=t2; showToast("✅ تم التغيير"); closePass(); }
        }
        function clearPass(){ t1=""; t2=""; t3=""; pStep=1; updatePassUI(); }
        function closePass(){ document.getElementById('passOverlay').style.display='none'; clearPass(); }

        function toggleMenu() { document.getElementById('logOverlay').style.display=='flex' ? closeModals() : openCalendar(); }
        function saveEmail(v) { localStorage.setItem('targetEmail', v); showToast("✅ تم حفظ الإيميل"); }
        function closeModals() { document.querySelectorAll('.overlay').forEach(o=>o.style.display='none'); selDays=[]; document.getElementById('rangeRes').innerHTML=""; }
    </script>
</body>
</html>
